<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>買い物リストアプリ</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #dc3545;
            --light-gray: #f8f9fa;
            --gray: #6c757d;
            --border-color: #dee2e6;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light-gray);
            color: #333;
            overscroll-behavior-y: contain; /* iOSでのバウンススクロール抑制 */
        }

        #app {
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
            background-color: #fff;
            min-height: calc(100vh - 30px); /* ビューポートの高さを確保 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* 初期表示 */
        #initial-view {
            display: flex;
            flex-direction: column;
        }

        #list-input {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            min-height: 200px;
            resize: vertical; /* 縦方向のリサイズのみ許可 */
        }

        button {
            display: block;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }

        #create-list-btn {
            background-color: var(--primary-color);
            color: white;
            margin-bottom: 10px;
        }
        #create-list-btn:hover {
            background-color: #0056b3;
        }

        /* リスト表示 */
        #list-view {
            display: none; /* 初期状態は非表示 */
        }

        .category h3 {
            margin-top: 25px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-size: 20px;
        }
        .category:first-child h3 {
            margin-top: 0;
        }

        .category ul,
        #completed-items ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .category li,
        #completed-items li {
            padding: 12px 5px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            font-size: 17px;
            word-break: break-word; /* 長い単語も折り返す */
        }

        .category li:last-child,
        #completed-items li:last-child {
            border-bottom: none;
        }

        input[type="checkbox"] {
            margin-right: 12px;
            /* チェックボックスを大きく、タップしやすくする */
            width: 22px;
            height: 22px;
            flex-shrink: 0; /* チェックボックスが縮まないように */
            appearance: none;
            -webkit-appearance: none;
            border: 2px solid var(--gray);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            top: -2px; /* ラベルとの垂直位置調整 */
        }

        input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* チェックマークのスタイル */
        input[type="checkbox"]:checked::after {
            content: '';
            display: block;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg) translate(-50%, -50%);
            position: absolute;
            left: 50%;
            top: 45%;
        }


        label {
            flex-grow: 1; /* ラベルが残りのスペースを埋める */
            cursor: pointer; /* ラベルクリックでもチェック可能に */
        }

        #completed-items {
            margin-top: 30px;
        }

        #completed-items h3 {
            margin-top: 0;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--gray);
            color: var(--gray);
            font-size: 20px;
        }

        #completed-items li label {
            text-decoration: line-through;
            color: var(--gray);
        }
        /* data-checked=true の場合、完了済みでなくても打ち消し線等をつける場合（今回は不要かも） */
        /*
        li[data-checked="true"] label {
             text-decoration: line-through;
             color: var(--gray);
        }
        */

        #reset-list-btn {
            background-color: var(--secondary-color);
            color: white;
            margin-top: 30px;
        }
        #reset-list-btn:hover {
            background-color: #c82333;
        }

    </style>
</head>
<body>
    <div id="app">
        <div id="initial-view">
            <textarea id="list-input" placeholder="ここに買い物リストを貼り付けます。
例：
[肉・魚]
鶏むね肉1枚(350g)
豚ひき肉200g、合いびき肉250g

[野菜]
大根11cm分(440g)
..."></textarea>
            <button id="create-list-btn">買い物リストを作る</button>
        </div>
        <div id="list-view">
            <div id="checklist">
                </div>
            <div id="completed-items">
                <h3>完了済み</h3>
                <ul>
                    </ul>
            </div>
            <button id="reset-list-btn">買い物リストを初期化する</button>
        </div>
    </div>

    <script>
        const initialView = document.getElementById('initial-view');
        const listView = document.getElementById('list-view');
        const listInput = document.getElementById('list-input');
        const createListBtn = document.getElementById('create-list-btn');
        const resetListBtn = document.getElementById('reset-list-btn');
        const checklistDiv = document.getElementById('checklist');
        const completedListUl = document.querySelector('#completed-items ul');
        const completedItemsDiv = document.getElementById('completed-items');

        // --- イベントリスナー ---
        createListBtn.addEventListener('click', createList);
        resetListBtn.addEventListener('click', resetList);
        // イベント委譲: チェックリスト全体のクリックを監視
        checklistDiv.addEventListener('change', handleCheckboxChange);
        completedListUl.addEventListener('change', handleCheckboxChange);
        // ラベルクリックでもチェックできるように
        checklistDiv.addEventListener('click', handleLabelClick);
        completedListUl.addEventListener('click', handleLabelClick);

        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            restoreState();
        }

        // --- 機能関数 ---

        function parseText(text) {
            const lines = text.trim().split('\n');
            const categories = [];
            let currentCategory = null;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return; // 空行はスキップ

                const categoryMatch = line.match(/^\[(.+?)\]$/);
                if (categoryMatch) {
                    // カテゴリ行
                    currentCategory = { title: categoryMatch[1], items: [] };
                    categories.push(currentCategory);
                } else if (currentCategory) {
                    // アイテム行
                    // 「、」で区切られている場合は分割
                    const items = line.split(/[、､　]/).map(item => item.trim()).filter(item => item); // 全角/半角スペース、読点で分割
                    currentCategory.items.push(...items);
                }
            });
            return categories;
        }

        function renderList(categories) {
            checklistDiv.innerHTML = ''; // 既存のリストをクリア
            completedListUl.innerHTML = ''; // 完了済みリストもクリア

            categories.forEach((category, categoryIndex) => {
                if (category.items.length === 0) return; // アイテムがないカテゴリは表示しない

                const categoryDiv = document.createElement('div');
                categoryDiv.classList.add('category');
                categoryDiv.dataset.categoryIndex = categoryIndex; // カテゴリインデックスを保持

                const title = document.createElement('h3');
                title.textContent = category.title;
                categoryDiv.appendChild(title);

                const ul = document.createElement('ul');
                category.items.forEach((item, itemIndex) => {
                    // ここで isChecked は常に false で初期化
                    const li = createListItem(item, categoryIndex, itemIndex, false);
                    ul.appendChild(li);
                });
                categoryDiv.appendChild(ul);
                checklistDiv.appendChild(categoryDiv);
            });

            // 完了済みリストの表示/非表示を初期化
            toggleCompletedVisibility();
        }

        function createListItem(itemText, categoryIndex, itemIndex, isChecked) {
            const li = document.createElement('li');
            li.dataset.categoryIndex = categoryIndex;
            li.dataset.itemIndex = itemIndex; // 元のインデックスも保持（必須ではないかも）
            li.dataset.itemText = itemText; // テキストも保持

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            // isChecked は restoreState で別途設定するため、ここでは初期状態を反映しない
            // checkbox.checked = isChecked;
            checkbox.id = `item-${categoryIndex}-${itemIndex}`; // 一意なID

            const label = document.createElement('label');
            label.htmlFor = checkbox.id; // ラベルとチェックボックスを関連付け
            label.textContent = itemText;

            li.appendChild(checkbox);
            li.appendChild(label);

            // isChecked フラグに基づいて data-checked 属性を初期設定（renderListからの呼び出しでは常にfalse）
            if(isChecked) {
                 li.dataset.checked = 'true';
            }

            return li;
        }

        function createList() {
            const inputText = listInput.value;
            if (!inputText.trim()) {
                alert('リストの内容を入力してください。');
                return;
            }
            const categories = parseText(inputText);
            if (categories.length === 0) {
                alert('有効なリスト形式が見つかりませんでした。\n例：[カテゴリ名]\nアイテム1');
                return;
            }

            renderList(categories);
            initialView.style.display = 'none';
            listView.style.display = 'block';
            saveState(); // 新規作成時はチェック状態は全てfalseで保存される
        }

        function handleCheckboxChange(event) {
            if (event.target.type === 'checkbox') {
                const li = event.target.closest('li');
                if (!li) return;

                const isChecked = event.target.checked;

                // 移動処理
                if (isChecked) {
                    moveItem(li, completedListUl);
                } else {
                    const categoryIndex = li.dataset.categoryIndex;
                    const targetUl = checklistDiv.querySelector(`.category[data-category-index="${categoryIndex}"] ul`);
                    if (targetUl) {
                         moveItem(li, targetUl);
                    } else {
                        console.error("元のカテゴリが見つかりません:", categoryIndex);
                        checklistDiv.querySelector('ul')?.prepend(li);
                    }
                }
                // 移動後に状態を保存
                saveState();
                toggleCompletedVisibility();
            }
        }

        function moveItem(liElement, targetUl) {
            targetUl.appendChild(liElement);
             // 見た目の更新（打ち消し線など）はCSSで行う想定
        }

        function handleLabelClick(event) {
            // ラベルクリック時の処理（特に変更なし）
            if (event.target.tagName === 'LABEL') {
                 // チェックボックス自体へのクリックイベントはブラウザが処理するので不要
            }
        }

        function toggleCompletedVisibility() {
            if (completedListUl.children.length > 0) {
                completedItemsDiv.style.display = 'block';
            } else {
                completedItemsDiv.style.display = 'none';
            }
        }


        function resetList() {
            if (confirm('本当に買い物リストを初期化しますか？')) {
                // ローカルストレージのデータをクリア
                localStorage.removeItem('isListVisible');
                localStorage.removeItem('checklistHtml');
                localStorage.removeItem('completedHtml');

                // DOMをクリア
                checklistDiv.innerHTML = '';
                completedListUl.innerHTML = '';
                listInput.value = '';

                // 表示切り替え
                listView.style.display = 'none';
                initialView.style.display = 'flex';
                toggleCompletedVisibility(); // 完了済みエリアを非表示に
            }
        }

        // --- 状態の保存と復元 (修正箇所) ---

        function saveState() {
            const isListVisible = listView.style.display === 'block';
            localStorage.setItem('isListVisible', isListVisible);

            if (isListVisible) {
                // --- ここから修正 ---
                // 全てのリストアイテムを取得し、チェック状態を data-checked 属性に反映
                const allListItems = document.querySelectorAll('#checklist li, #completed-items li');
                allListItems.forEach(li => {
                    const checkbox = li.querySelector('input[type="checkbox"]');
                    if (checkbox && checkbox.checked) {
                        li.dataset.checked = 'true'; // チェックされていれば属性を設定
                    } else {
                        li.removeAttribute('data-checked'); // チェックされていなければ属性を削除
                    }
                });
                // --- 修正ここまで ---

                // data-checked 属性が更新された後の HTML 構造を保存
                localStorage.setItem('checklistHtml', checklistDiv.innerHTML);
                localStorage.setItem('completedHtml', completedListUl.innerHTML);
            }
        }

        function restoreState() {
            const isListVisible = localStorage.getItem('isListVisible') === 'true';

            if (isListVisible) {
                const checklistHtml = localStorage.getItem('checklistHtml');
                const completedHtml = localStorage.getItem('completedHtml');

                if (checklistHtml !== null && completedHtml !== null) {
                    // HTML構造を復元
                    checklistDiv.innerHTML = checklistHtml;
                    completedListUl.innerHTML = completedHtml;

                    // --- ここから修正 ---
                    // 復元したHTML内の data-checked 属性に基づいてチェックボックスの状態を設定
                    const allRestoredItems = document.querySelectorAll('#checklist li, #completed-items li');
                    allRestoredItems.forEach(li => {
                        const checkbox = li.querySelector('input[type="checkbox"]');
                        if (checkbox) {
                            // li要素に data-checked="true" があれば、チェックボックスをチェック状態にする
                            if (li.dataset.checked === 'true') {
                                checkbox.checked = true;
                            } else {
                                checkbox.checked = false; // なければ非チェック状態にする
                            }
                        }
                    });
                    // --- 修正ここまで ---

                    // 表示状態を切り替え
                    initialView.style.display = 'none';
                    listView.style.display = 'block';

                    // 完了済みリストの表示/非表示を更新
                    toggleCompletedVisibility();

                } else {
                    // 保存されたデータが不完全なら初期表示
                    showInitialView();
                }
            } else {
                // リストが表示されていなかった場合も初期表示
                showInitialView();
            }
        }

        function showInitialView() {
            listView.style.display = 'none';
            initialView.style.display = 'flex';
        }

    </script>
</body>
</html>
